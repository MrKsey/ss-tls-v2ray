limit_req_zone $binary_remote_addr zone=limitreqsbyaddr:100k rate=5r/m;
limit_req_status 429;

server {
	      listen 80;
	      server_name  $V2RAY_DOMAIN;
        
        location /.well-known {
                root $CONFIG_PATH/nginx/www;
        }

        location / {
        	      return 301 https://$host$request_uri;
        }
}

server {
        listen 443 ssl http2;
	      server_name $V2RAY_DOMAIN;
        
	      ssl_certificate $CONFIG_PATH/letsencrypt/live/$V2RAY_DOMAIN/fullchain.pem;
	      ssl_certificate_key $CONFIG_PATH/letsencrypt/live/$V2RAY_DOMAIN/privkey.pem;
	      ssl_trusted_certificate $CONFIG_PATH/letsencrypt/live/$V2RAY_DOMAIN/chain.pem;
	
        location / {
                root $CONFIG_PATH/nginx/www;
                index index.html;
                limit_req zone=limitreqsbyaddr;
        }

        location /AUTO-$V2RAY_CLIENT_NUMBER-$V2RAY_SECRET { proxy_pass http://127.0.0.1:$V2RAY_SERVER_PORT/; proxy_redirect off; proxy_buffering off; proxy_http_version 1.1; proxy_set_header Host $http_host; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection "upgrade"; }
}
